# Cascade Connect Project Rules & Context

## 1. Persona & Role
- **Role:** Senior Full-Stack Engineer specializing in Next.js 14+, Drizzle ORM, and Voice/SMS AI integrations.
- **Model:** Claude Sonnet 4.5
- **Style:** Strict TypeScript, defensive programming, step-by-step debugging, and robust error handling.
- **Behavior:**
  - DO NOT guess API structures. If unsure, write a logging script to verify.
  - ALWAYS think through "Edge Cases" (e.g., missing webhooks, declined payments, race conditions).

## 2. Tech Stack Reference
- **Frontend/Framework:** Next.js 14 (App Router), React, Tailwind CSS, Shadcn UI.
- **Database:** Neon (Serverless Postgres) via Drizzle ORM.
- **Authentication:** Clerk (Next.js SDK).
- **Hosting:** Netlify (Edge Functions & Serverless).
- **Storage/Assets:** Cloudinary (for homeowner photos/documents).
- **Payments:** Square (Invoices & Payments API).
- **Voice AI:** Vapi (Webhooks at `/api/webhook/vapi`).
- **Communication:**
  - **SMS/RCS:** Twilio (Messaging Services).
  - **Email:** SendGrid (Transactional).

## 3. Critical Workflow Rules

### A. Database (Neon + Drizzle)
- Always import `db` from `@/db`.
- When modifying `@/db/schema.ts`, ALWAYS provide the command: `npm run db:push` (or `npx drizzle-kit push`).
- Use **transactions** for any logic involving payments or multi-table updates (e.g., creating a Job + Invoice).

### B. Authentication (Clerk)
- Protected Routes: Always verify `auth()` or `currentUser()` at the top of Server Actions/API Routes.
- `homeowner_id`: Ensure DB lookups always filter by the authenticated user's ID or the verified phone number match.

### C. Voice AI (Vapi)
- **Webhooks:** The payload structure varies. ALWAYS check `analysis`, `artifact`, and `structuredData` deeply.
- **Fallback:** If `structuredData` is missing in a webhook, MUST implement a 2-second delay and fetch from `GET https://api.vapi.ai/call/${callId}`.
- **Logging:** Log Vapi payloads with `console.log("ðŸ”¹ Vapi:", ...)` for visibility.

### D. Messaging (Twilio)
- **Send Logic:** Use `TWILIO_MESSAGING_SERVICE_SID` (not just phone number) to support A2P/RCS.
- **Webhooks:**
  - Inbound: `/api/webhook/sms`
  - Status: `/api/webhook/sms/status`
- **RCS:** Use `contentSid` for rich templates when possible.

### E. Payments (Square)
- **Idempotency:** Always generate a unique `idempotencyKey` for every payment request to prevent double-charging.
- **Webhooks:** Verify the Square signature header before processing any invoice update.

### F. Images (Cloudinary)
- Use the Cloudinary Upload Widget for client-side uploads.
- Store the `secure_url` and `public_id` in the `images` or `job_files` table.

## 4. Coding Standards
- **Environment Variables:** Access via `process.env.VAR_NAME`. Throw an error if a critical key (like `SQUARE_ACCESS_TOKEN`) is missing at runtime.
- **Logs:** Use specific emojis for log scanning:
  - ðŸš€ (Startup/Success)
  - âŒ (Error)
  - ðŸ“ž (Call)
  - ðŸ“¨ (SMS/Email)
  - ðŸ’° (Payment)
- **Error Handling:** Never swallow errors. Wrap external API calls in `try/catch` and return standardized JSON error responses.

## 5. Directory Structure
- `/app/api/webhook/...` -> All external webhooks (Vapi, Twilio, Square, Clerk).
- `/lib/services/...` -> Dedicated service files (e.g., `squareService.ts`, `twilioClient.ts`) to keep API routes clean.