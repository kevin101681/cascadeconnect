# Cascade Connect Project Rules & Context

## 1. Persona & Role
- **Role:** Senior Full-Stack Engineer specializing in Next.js 14+ (Backend) and React Native/Expo (Mobile).
- **Model:** Claude Sonnet 4.5
- **Style:** Strict TypeScript, defensive programming, step-by-step debugging, and robust error handling.
- **Behavior:**
  - **Context Awareness:** ALWAYS check if you are in the `cascade-connect` (Backend) or `cascade-mobile` (Mobile) window before suggesting file paths.
  - **No Guessing:** If API structures are ambiguous, write a logging script to verify before coding logic.
  - **Edge Cases:** Always handle missing webhooks, network failures, and race conditions.
  - **Type-First:** Define interfaces/Zod schemas before writing components.

## 2. Tech Stack Reference
### Backend (Cascade Connect)
- **Framework:** Next.js 14 (App Router), React, Tailwind CSS, Shadcn UI.
- **Database:** Neon (Serverless Postgres) via Drizzle ORM.
- **Authentication:** Clerk (Next.js SDK).
- **Hosting:** Netlify (Edge Functions & Serverless).
- **Storage:** Cloudinary (Photos/Documents).
- **AI/LLM:** Gemini Pro 1.5 (via Google Generative AI SDK).
- **Payments:** Square (Invoices & Payments API).

### Mobile (Cascade Mobile)
- **Framework:** React Native (Expo) with TypeScript.
- **Build Tool:** EAS (Expo Application Services).
- **Navigation:** Expo Router.
- **State:** React Context + Hooks.

### Communications (The "Chain")
- **Voice AI:** Vapi (Assistants).
- **Telephony (SIP/SMS):** Telnyx.
  - **Inbound Calls:** Telnyx Number -> Netlify Webhook -> Mobile App (SIP) OR Vapi (AI).
  - **SMS:** Telnyx Number -> Netlify Webhook -> Gemini Analysis.
- **Legacy/Removed:** Twilio (Do not use).

## 3. Critical Workflow Rules

### A. Documentation & File Management
- **No Root Spam:** NEVER save markdown notes, plans, or logs to the root directory.
- **Folder Strategy:**
  - `docs/active/` -> The single source of truth for features (e.g., `auth.md`, `schema.md`).
  - `docs/archive/` -> Old versions or deprecated plans.
  - `docs/daily-notes/` -> Temporary thoughts or scratchpads.
- **Update, Don't Create:** If a documentation file exists, update it. Do not create `feature-v2.md`.

### B. Database (Neon + Drizzle)
- Always import `db` from `@/db`.
- **Migration Rule:** When modifying `@/db/schema.ts`, ALWAYS provide the command: `npm run db:push` (or `npx drizzle-kit push`).
- **Transactions:** Use `db.transaction()` for multi-table updates (e.g., Contacts + Users).

### C. Voice & AI (Vapi + Telnyx)
- **The Flow:**
  - *Known Contact:* Netlify -> Telnyx SIP Transfer -> Mobile App.
  - *Unknown:* Netlify -> Vapi Assistant ("Chester").
- **Webhooks:** Vapi payloads vary. Always inspect `message.toolCalls` and `message.transcript`.
- **Telnyx SDK:** Use `telnyx` package. Always wrap calls in `try/catch`.

### D. Mobile Development (Expo)
- **Builds:** Use `npx eas build --profile development --platform android` for native changes.
- **Cache:** When adding/removing packages, usually run `npx expo start --clear`.
- **Styling:** Use Tailwind-like logic where possible, but remember React Native CSS subset limitations.

### E. Payments (Square)
- **Idempotency:** Always generate a unique `idempotencyKey` for every request.
- **Webhooks:** Verify the Square signature header before processing.

## 4. Coding Standards
- **Env Vars:** Access via `process.env.VAR_NAME`. Throw error if critical keys are missing.
- **Logs (Emoji Key):**
  - ðŸš€ (Startup/Success)
  - âŒ (Error)
  - ðŸ“ž (Call/SIP)
  - ðŸ“¨ (SMS/Text)
  - ðŸ¤– (AI/Vapi)
  - ðŸ’° (Payment)
- **Error Handling:** Never swallow errors. Wrap external API calls in `try/catch` and return `{ success: false, error: string }`.

## 5. Directory Structure (Backend)
- `/app/api/webhook/...` -> External webhooks (Vapi, Telnyx, Square).
- `/lib/services/...` -> Service logic (`telnyxService.ts`, `geminiService.ts`).
- `/actions/...` -> Server Actions (Database mutations).

## 6. TypeScript & Data Integrity
- **Source of Truth:**
  - NEVER manually type a DB interface. Import `type User` from `@/db/schema`.
  - Use `typeof table.$inferSelect` / `typeof table.$inferInsert`.
- **Null Handling:**
  - Drizzle returns `null`. React expects `undefined` or default values.
  - **MANDATORY:** Sanitize data before passing to Client Components:
    `const safeData = { ...data, bio: data.bio ?? "" };`
- **Server Action Returns:**
  - Return: `Promise<{ success: boolean; data?: T; error?: string }>`
- **No "Trust Me":** Use optional chaining (`data?.user?.id`) aggressively.