<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homeowner Manual - Cascade Builder Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .tab-button {
            transition: all 0.2s ease;
        }
        
        .tab-button:hover {
            transform: translateY(-1px);
        }
        
        .tab-button.active {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .spinner {
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        iframe {
            border: none;
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- Main Container -->
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-200">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-800">Homeowner Manual</h1>
                        <p class="text-sm text-gray-600 mt-1" id="sectionTitle">Cover & Quick Reference</p>
                    </div>
                    
                    <!-- Download PDF Button -->
                    <button
                        id="downloadBtn"
                        onclick="downloadPDF()"
                        class="flex items-center gap-2 px-4 py-2 rounded-lg text-white hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all text-sm font-medium shadow-md hover:shadow-lg"
                        style="background-color: #3C6B80;"
                        title="Download as PDF"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        <span id="downloadText">Download PDF</span>
                    </button>
                </div>

                <!-- Section Navigation Tabs -->
                <div class="flex items-center gap-2 flex-wrap">
                    <button onclick="navigateToSection(1)" class="tab-button active px-3 py-1.5 rounded-lg text-xs font-medium text-white" style="background-color: #3C6B80;" data-section="1">
                        Cover & Quick Reference
                    </button>
                    <button onclick="navigateToSection(2)" class="tab-button px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-section="2">
                        Understanding Your Warranty Team
                    </button>
                    <button onclick="navigateToSection(3)" class="tab-button px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-section="3">
                        Emergency: No Heat
                    </button>
                    <button onclick="navigateToSection(4)" class="tab-button px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-section="4">
                        Emergency: Plumbing Leaks
                    </button>
                    <button onclick="navigateToSection(5)" class="tab-button px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-section="5">
                        Glossary & Contacts
                    </button>
                    <button onclick="navigateToSection(6)" class="tab-button px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-section="6">
                        Notes
                    </button>
                </div>
            </div>
            
            <!-- Manual Content -->
            <div id="manualContainer" style="height: calc(100vh - 280px); min-height: 400px; overflow: hidden;">
                <iframe 
                    id="manualIframe"
                    src="/complete_homeowner_manual.html" 
                    title="Homeowner Manual"
                    style="height: 100%;"
                ></iframe>
            </div>
        </div>
    </div>

    <script>
        let currentSection = 1;
        const sections = [
            { id: 1, title: 'Cover & Quick Reference', selector: '.cover' },
            { id: 2, title: 'Understanding Your Warranty Team', selector: '.page:nth-of-type(2)' },
            { id: 3, title: 'Emergency: No Heat', selector: '.page:nth-of-type(3)' },
            { id: 4, title: 'Emergency: Plumbing Leaks', selector: '.page:nth-of-type(4)' },
            { id: 5, title: 'Glossary & Contacts', selector: '.page:nth-of-type(5)' },
            { id: 6, title: 'Notes', selector: '.page:nth-of-type(6)' }
        ];

        function navigateToSection(sectionId) {
            currentSection = sectionId;
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;

            // Update section title
            document.getElementById('sectionTitle').textContent = section.title;

            // Update tab styles
            document.querySelectorAll('.tab-button').forEach(btn => {
                const btnSection = parseInt(btn.getAttribute('data-section'));
                if (btnSection === sectionId) {
                    btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    btn.classList.add('active', 'text-white');
                    btn.style.backgroundColor = '#3C6B80';
                } else {
                    btn.classList.remove('active', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    btn.style.backgroundColor = '';
                }
            });

            // Scroll iframe to section
            const iframe = document.getElementById('manualIframe');
            if (iframe && iframe.contentWindow && iframe.contentWindow.document) {
                const iframeDoc = iframe.contentWindow.document;
                
                if (section.id === 1) {
                    iframe.contentWindow.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    const element = iframeDoc.querySelector(section.selector);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }

                // Adjust container height based on section
                setTimeout(() => {
                    const element = section.id === 1 
                        ? iframeDoc.querySelector('.cover')
                        : iframeDoc.querySelector(section.selector);
                    
                    if (element) {
                        const height = element.scrollHeight;
                        const container = document.getElementById('manualContainer');
                        const maxHeight = window.innerHeight - 280;
                        const newHeight = Math.min(height + 100, maxHeight);
                        container.style.height = `${Math.max(newHeight, 400)}px`;
                    }
                }, 100);
            }
        }

        async function downloadPDF() {
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadText = document.getElementById('downloadText');
            
            // Disable button and show loading
            downloadBtn.disabled = true;
            downloadText.textContent = 'Generating...';
            downloadBtn.innerHTML = `
                <div class="spinner"></div>
                <span>Generating...</span>
            `;

            try {
                const iframe = document.getElementById('manualIframe');
                if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                    throw new Error('Unable to access manual content');
                }

                const iframeDoc = iframe.contentWindow.document;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'letter');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                // Get all page sections
                const pageSections = iframeDoc.querySelectorAll('.page, .cover');
                
                for (let i = 0; i < pageSections.length; i++) {
                    const section = pageSections[i];
                    
                    // Capture section as image
                    const canvas = await html2canvas(section, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: section.classList.contains('cover') ? null : '#ffffff',
                        windowWidth: 850,
                        windowHeight: section.scrollHeight,
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pdfWidth;
                    const imgHeight = (canvas.height * pdfWidth) / canvas.width;
                    
                    if (i > 0) {
                        pdf.addPage();
                    }
                    
                    // Handle tall sections
                    if (imgHeight > pdfHeight) {
                        let heightLeft = imgHeight;
                        let position = 0;
                        
                        while (heightLeft > 0) {
                            if (position > 0) {
                                pdf.addPage();
                            }
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pdfHeight;
                            position -= pdfHeight;
                        }
                    } else {
                        const yOffset = (pdfHeight - imgHeight) / 2;
                        pdf.addImage(imgData, 'PNG', 0, yOffset, imgWidth, imgHeight);
                    }
                }

                pdf.save('Cascade-Homeowner-Manual.pdf');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Please try again.');
            } finally {
                // Re-enable button
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    <span>Download PDF</span>
                `;
            }
        }

        // Wait for iframe to load before enabling navigation
        window.addEventListener('load', () => {
            const iframe = document.getElementById('manualIframe');
            iframe.addEventListener('load', () => {
                // Initialize to first section
                navigateToSection(1);
            });
        });
    </script>
</body>
</html>

